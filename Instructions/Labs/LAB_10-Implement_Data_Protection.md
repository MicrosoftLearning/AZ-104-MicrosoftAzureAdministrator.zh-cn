---
lab:
  title: 实验室 10：实现数据保护
  module: Administer Data Protection
---

# 实验室 10 - 实现数据保护

## 实验室简介    

在本实验室中，你将了解 Azure 虚拟机的备份和恢复。 你将了解如何为 Azure 虚拟机创建恢复服务保管库和备份策略。 你将了解如何使用 Azure Site Recovery 进行灾难恢复。 

本实验室需要 Azure 订阅。 订阅类型可能会影响此实验室中功能的可用性。 你可更改区域，但这些步骤是使用“美国东部”和“美国西部”编写的。********

## 预计用时：50 分钟

## 实验室方案

你的组织正在评估如何备份 Azure 虚拟机，以及如何在因意外或恶意发生数据丢失后进行还原。 此外，组织还希望探索将 Azure Site Recovery 用于灾难恢复方案。 

## 交互式实验室模拟

你可能会发现有一个交互式实验室模拟对本主题很有用。 通过模拟，可按照自己的节奏点击浏览类似的场景。 交互式模拟与本实验室之间存在差异，但许多核心概念是相同的。 不需要 Azure 订阅。

+ **[备份虚拟机和本地文件。](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2016)** 创建一个恢复服务保管库并实施 Azure 虚拟机备份。 使用 Microsoft Azure 恢复服务代理实施本地文件和文件夹备份。 本地备份超出了本实验室的内容范围，但查看这些步骤可能会有所帮助。 

## 工作技能

+ 任务 1：使用模板预配基础结构。
+ 任务 2：创建和配置恢复服务保管库。
+ 任务 3：配置 Azure 虚拟机级备份。
+ 任务 4：监视 Azure 备份。
+ 任务 5：启用虚拟机复制。 

## 预计用时：40 分钟

## 体系结构关系图

![体系结构任务示意图。](../media/az104-lab10-architecture.png)

## 任务 1：使用模板预配基础结构

在此任务中，你将使用模板来部署虚拟机。 该虚拟机将用来测试不同的备份方案。

1. 下载 **\\Allfiles\\Lab10\\** 实验室文件。

1. 登录 **Azure 门户** - `https://portal.azure.com`。

1. 搜索并选择 `Deploy a custom template`。

1. 在“自定义部署”页上，选择“在编辑器中生成自己的模板”****。

1. 在“编辑模板”页上，选择“加载文件”****。

1. 找到并选择 **\\Allfiles\\Lab10\\az104-10-vms-edge-template.json** 文件，然后选择“打开”。****

   >**注意：** 花点时间来查看模板。 我们将部署虚拟网络和虚拟机，以便可以演示备份和恢复。 

1. **保存**所做更改。

1. 选择“编辑参数”，然后选择“加载文件”。********

1. 加载并选择 **\\Allfiles\\Lab10\\az104-10-vms-edge-parameters.json** 文件。

1. **保存**所做更改。

1. 使用以下信息完成自定义部署字段，并将所有其他字段保留其默认值：

    | 设置       | 值         | 
    | ---           | ---           |
    | 订阅  | Azure 订阅 |
    | 资源组| `az104-rg-region1`（如有必要，请选择“新建”****）
    | 区域        | **美国东部**   |
    | 用户名      | localadmin   |
    | 密码      | 提供复杂的密码 |

1. 依次选择**查看 + 创建**、**创建**

    >**注意：** 等待模板部署，然后选择“转到资源”。**** 你应当在一个虚拟网络中拥有一个虚拟机。 

## 任务 2：创建和配置恢复服务保管库

在此任务中，你将创建一个恢复服务保管库。 恢复服务保管库为虚拟机数据提供存储。 

1. 在 Azure 门户中，搜索并选择 `Recovery Services vaults`，然后在“恢复服务保管库”边栏选项卡上单击“+ 创建”。********

1. 在“创建恢复服务保管库”边栏选项卡上，指定以下设置：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | Azure 订阅的名称 |
    | 资源组 | `az104-rg-region1`  |
    | 保管库名称 | `az104-rsv-region1` |
    | 区域 | **美国东部** |

    >注意：请确保指定在上一个任务中向其中部署了虚拟机的同一区域。

    ![恢复服务保管库的屏幕截图。](../media/az104-lab10-create-rsv.png)

1. 单击“查看 + 创建”，确保通过验证，然后单击“创建”。********

    >备注：请等待部署完成。 该部署应当会花费几分钟时间。 

1. 部署完成后，单击“前往资源”。

1. 在“**设置**”部分中，单击“**属性**”。

1. 选择“备份配置”标签下的“更新”链接。********

1. 在“备份配置”**** 边栏选项卡上，查看“存储复制类型”**** 的选项。 保留“异地冗余”默认设置，关闭边栏选项卡。

    >**注意**：只有不存在现有备份项目时才能配置此设置。
    
    >你知道吗？**** 通过“跨区域还原”选项，你可在次要的 [Azure 配对区域](https://learn.microsoft.com/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore)中还原数据。 

1. 选择“安全设置”>“软删除和安全设置”标签下的“更新”链接。********

1. 在“安全设置”边栏选项卡上，请注意，“软删除(对于在 Azure 中运行的工作负载)”为“已启用”  。 请注意，软删除保留期为 14 天。******** 

>你知道吗？**** Azure 有两种类型的保管库：“恢复服务保管库”与“备份保管库”。 主要区别在于可以备份的数据源。 详细了解[区别](https://learn.microsoft.com/answers/questions/405915/what-is-difference-between-recovery-services-vault)。

## 任务 3：配置 Azure 虚拟机级备份

在此任务中，你将实现 Azure 虚拟机级备份。 作为 VM 备份的一部分，你需要定义适用于备份的备份和保留策略。 可以为不同的 VM 分配不同的备份和保留策略。

   >**注意**：开始本任务之前，请确保在本实验室第一个任务中开始的部署已顺利完成。

1. 在“恢复服务保管库”边栏选项卡上，单击“概述”，然后单击“+ 备份”。********

1. 在“备份目标”边栏选项卡上，指定以下设置：

    | 设置 | 值 |
    | --- | --- |
    | 你的工作负载在哪里运行? | **** Azure（请注意其他选项） |
    | 想要备份什么？ | **** 虚拟机（请注意其他选项） |

1. 选择“备份”。

1. 请注意，有两种策略子类型****：“增强”和“标准”。******** 查看选项并选择“标准”。**** 

1. 在“备份策略”中，选择“创建新策略”。********

1. 使用以下设置定义新备份策略（其他设置保留默认值）：

    | 设置 | 值 |
    | ---- | ---- |
    | 策略名称 | `az104-backup` |
    | 频率 | **每日** |
    | 时间 | 凌晨 12:00 |
    | 时区 | 当地时区的名称 |
    | 即时恢复快照保留时间 | 2 天 |

    ![备份策略页的屏幕截图。](../media/az104-lab10-backup-policy.png)

1. 单击“**确定**”创建策略，然后在“**虚拟机**”部分中，选择“**添加**”（向下滚动）。

1. 在“选择虚拟机”边栏选项卡上，选择“az-104-10-vm0”，单击“确定”，然后返回“备份”边栏选项卡，单击“启用备份”。********************

    >**注意**：等待启用备份。 此过程大约需要 2 分钟。

1. 部署完成后，选择“转到资源”****。
   
1. 在“受保护的项”部分中，单击“备份项”，然后单击“Azure 虚拟机”条目。************

1. 选择 az104-10-vm0 对应的“查看详细信息”链接，查看“备份预检查”和“上次备份状态”条目的值。****************

    >**注意：** 请注意，备份处于挂起状态。
    
1. 选择“立即备份”，接受“保留备份截止日期”下拉列表中的默认值，然后单击“确定”。************

    >**注意**：不要等待备份完成，而是继续执行下一个任务。

## 任务 4：监视 Azure 备份

在此任务中，你将部署一个 Azure 存储帐户。 然后，你将保管库配置为将日志和指标发送到存储帐户。 然后，可以将此存储库与 Log Analytics 或其他第三方监视解决方案一起使用。

1. 在 Azure 门户中，搜索并选择 `Storage accounts`。

1. 在“存储帐户”页上，选择“创建”。****

1. 使用以下信息定义存储帐户，然后选择“**查看 + 创建**”。

    | 设置 | 值 |
    | --- | --- | 
    | 订阅          | *订阅*    |
    | 资源组        | **** az104-rg-region1        |
    | 存储帐户名称  | 提供全局唯一名称   |
    | 区域                | **美国东部**   |

1. 选择**创建**。

    >备注：请等待部署完成。 此操作大约需要 1 分钟。

1. 搜索并选择你的恢复服务保管库。

1. 在“**监视**”边栏选项卡中，选择“**诊断设置**”，然后选择“**添加诊断设置**”。

1. 将设置命名为 `Logs and Metrics to storage`。

1. 选中以下日志和指标类别旁边的复选框：

    - **** Azure 备份报告数据
    - **** 附加 Azure 备份作业数据
    - **** 附加 Azure 备份警报数据
    - **** Azure Site Recovery 作业
    - **** Azure Site Recovery 事件

1. 在目标详细信息中，选中“存档到存储帐户”旁边的复选框。****

1. 在“存储帐户”下拉列表中，选择你之前在此任务中创建的存储帐户。

1. 选择“保存”。

1. 返回到你的恢复服务保管库，在“监视”边栏选项卡中选择“备份作业”。********

1. 找到 az104-10-vm0 虚拟机的备份操作。**** 

1. **查看备份作业的详细信息**（滚动到右侧的链接）。

## 任务 5：启用虚拟机复制

1. 在 Azure 门户中，搜索并选择 `Recovery Services vaults`，然后在“恢复服务保管库”边栏选项卡上单击“+ 创建”。********

1. 在“创建恢复服务保管库”边栏选项卡上，指定以下设置：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | Azure 订阅的名称 |
    | 资源组 | `az104-rg-region2`（如有必要，请选择“新建”****） |
    | 保管库名称 | `az104-rsv-region2` |
    | 区域 | **美国西部** |

    >**注意**：请确保指定与虚拟机不同的区域。****

1. 单击“查看 + 创建”，确保通过验证，然后单击“创建”。********

    >备注：请等待部署完成。 该部署应当会花费几分钟时间。 

1. 搜索并选择 `az104-10-vm0` 虚拟机。

1. 在“备份 + 灾难恢复”边栏选项卡中，选择“灾难恢复”。******** 

1. 在“基本信息”选项卡上，注意“目标区域”。********

1. 选择“下一步：高级设置”。**** 已为你选择资源。 

1. 向下滚动并**创建**自动化帐户。 

   >**备注：** 请务必填充设置，否则验证将失败。 

1. 选择“查看 + 开始复制”，然后选择“启用复制”。********

    >**注意**：启用复制需要 10-15 分钟。 查看门户右上角的通知消息。 等待时，可以查看一下本页末尾的自定进度培训链接。
    
1. 完成复制后，搜索并找到你的恢复服务保管库 az104-rsv-region2。**** 你可能需要**刷新**页面。 

1. 在“受保护的项”部分中，选择“复制的项”。********

1. 检查虚拟机是否显示复制运行状况正常。 请注意，该状态将显示同步（从 0% 开始）状态，并且最终在初始同步完成后显示“受保护”。****

   ![“复制的项”页面的屏幕截图。](../media/az104-lab10-replicated-items.png)

1. 选择虚拟机以查看更多详细信息。
   
>你知道吗？**** 你最好测试受保护 VM 的故障转移。[](https://learn.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure#run-a-test-failover-for-a-single-vm)

## 清理资源

如果使用自己的订阅，需要一点时间删除实验室资源****。 这将确保资源得到释放，并将成本降至最低。 删除实验室资源的最简单方法是删除实验室资源组。 

+ 在 Azure 门户中，选择资源组，选择“删除资源组”，输入资源组名称，然后单击“删除”************。
+ `Remove-AzResourceGroup -Name resourceGroupName`（使用 Azure PowerShell）。
+ `az group delete --name resourceGroupName`（使用 CLI）。

## 使用 Copilot 扩展学习
Copilot 可帮助你了解如何使用 Azure 脚本工具。 Copilot 还可以帮助了解实验室中未涵盖的领域或需要更多信息的领域。 打开 Edge 浏览器并选择“Copilot”（右上角）或导航到*copilot.microsoft.com*。 花几分钟时间尝试这些提示。

+ Azure 备份支持哪些产品？
+ 总结使用 Azure 备份备份和还原 Azure 虚拟机的步骤。
+ 如何使用 Azure PowerShell 或 CLI 检查 Azure 备份作业的状态。
+ 提供至少五种用于配置 Azure 虚拟机备份的最佳做法。  

## 通过自定进度的培训了解详细信息

+ [](https://learn.microsoft.com/training/modules/protect-virtual-machines-with-azure-backup/)使用 Azure 备份保护虚拟机。 使用 Azure 备份来帮助保护本地服务器、虚拟机、SQL Server、Azure 文件共享和其他工作负载。
+ [使用 Azure Site Recovery 保护 Azure 基础结构](https://learn.microsoft.com/en-us/training/modules/protect-infrastructure-with-site-recovery/)。 使用 Azure Site Recovery 来自定义 Azure 虚拟机的复制、故障转移和故障回复，从而为 Azure 基础结构提供灾难恢复能力。

## 关键结论

恭喜你完成本实验室的内容。 下面是本实验室的主要内容。 

+ Azure 备份服务提供简单、安全且经济高效的解决方案来备份和恢复数据。
+ Azure 备份可以保护本地和云资源，包括虚拟机和文件共享。
+ Azure 备份策略配置备份频率和恢复点的保留期。 
+ Azure Site Recovery 是一种灾难恢复解决方案，可为虚拟机和应用程序提供保护。
+ Azure Site Recovery 将你的工作负载复制到辅助站点，在发生服务中断或灾难时，你可以故障转移到辅助站点并快速恢复运行，从而最大程度地减少停机时间。
+ 恢复服务保管库存储你的备份数据，并最大程度地减少管理开销。
