---
lab:
  title: 实验室 06：实现网络流量管理
  module: Administer Network Traffic Management
---

# 实验室 06 - 实现网络流量管理

## 实验室简介

在本实验室中，可了解如何配置和测试公共负载均衡器和应用程序网关。

本实验室需要 Azure 订阅。 订阅类型可能会影响此实验室中功能的可用性。 可更改区域，但这些步骤是使用“美国东部”编写的****。

## 预计用时：50 分钟

## 实验室方案

你的组织有一个公共网站。 你需要跨不同虚拟机对传入的公共请求进行负载均衡。 还需要提供来自不同虚拟机的图像和视频。 你计划实施 Azure 负载均衡器和 Azure 应用程序网关。 所有资源都位于同一区域中。

## 交互式实验室模拟

你可能会发现一些交互式实验室模拟对本主题很有用。 通过模拟，可按照自己的节奏点击浏览类似的场景。 交互式模拟与本实验室之间存在差异，但许多核心概念是相同的。 不需要 Azure 订阅。

+ [创建并配置 Azure 负载均衡器](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Create%20and%20configure%20an%20Azure%20load%20balancer)。 创建虚拟网络、后端服务器、负载均衡器，然后测试负载均衡器。
+ [部署 Azure 应用程序网关](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Deploy%20Azure%20Application%20Gateway)。 创建应用程序网关、虚拟机和后端池，并测试网关。
+ [实现流量管理](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2010)。 实现完整的中心辐射型网络，包括虚拟机、虚拟网络、对等互连、负载均衡器和应用程序网关。

## 工作技能

+ 任务 1：使用模板预配基础结构。
+ 任务 2：配置 Azure 负载均衡器。
+ 任务 3：配置 Azure 应用程序网关。

## 任务 1：使用模板预配基础结构

在此任务中，你将使用模板部署一个虚拟网络、一个网络安全组，以及三台虚拟机。

1. 下载 \\Allfiles\\Lab06 实验室文件（模板和参数）****。

1. 登录 **Azure 门户** - `https://portal.azure.com`。

1. 搜索并选择 `Deploy a custom template`。

1. 在“自定义部署”页面中，选择“在编辑器中生成自己的模板”****。

1. 在“编辑模板”页上，选择“加载文件”****。

1. 查找并选择 \\Allfiles\\Lab06\\az104-06-vms-template.json 文件，然后选择“打开”********。

1. 选择“保存”。

1. 选择“编辑参数”并加载 \\Allfiles\\Lab06\\az104-06-vms-parameters.json 文件********。

1. 选择“保存”。

1. 使用以下信息填写自定义部署页上的字段，并保留所有其他字段的默认值。

    | 设置       | 值         |
    | ---           | ---           |
    | 订阅  | 你的 Azure 订阅 |
    | 资源组 | `az104-rg6`（如有必要，请选择“新建”****） |
    | 密码      | 提供安全密码 |

    >**注意**：如果收到 VM 大小不可用的错误，请选择订阅中可用的 SKU，并且至少有 2 个核心。

1. 选择“查看 + 创建”，然后选择“创建”。

    >**注意**：请等待部署完成后再继续下一个任务。 部署大约需要 5 分钟。

    >**注意**：查看正在部署的资源。 将有一个包含三个子网的虚拟网络。 每个子网都有一个虚拟机。

## 任务 2：配置 Azure 负载均衡器

在此任务中，你将在虚拟网络中的两台 Azure 虚拟机前实现 Azure 负载均衡器。 Azure 中的负载均衡器跨资源（例如虚拟机）提供第 4 层连接。 负载均衡器配置包括前端 IP 地址（用于接受连接）、后端池以及定义连接应如何遍历负载均衡器的规则。

## 体系结构图 - 负载均衡器

>**注意**：请注意，负载均衡器分布在同一虚拟网络中的两个虚拟机上。

![实验室任务示意图。](../media/az104-lab06-lb-architecture.png)

1. 在 Azure 门户中，搜索并选择 `Load balancers`，在“负载均衡器”边栏选项卡上，单击“+ 创建”。********

1. 创建一个负载均衡器，其设置如下（其他设置保留默认值），然后单击“下一步:**** 前端 IP 配置”：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | 你的 Azure 订阅 |
    | 资源组 | **az104-rg6** |
    | 名称 | `az104-lb` |
    | 区域 | 部署 VM 的同一区域**** |
    | SKU  | **标准** |
    | 类型 | **Public** |
    | 层 | **Regional** |

     ![“创建负载均衡器”页的屏幕截图。](../media/az104-lab06-create-lb1.png)

1. 在“前端 IP 配置”选项卡上，单击“添加前端 IP 配置”并使用以下设置 ：  

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-fe` |
    | IP 类型 | IP 地址 |
    | 网关负载均衡器 | 无 |
    | 公共 IP 地址 | 选择“新建”（使用下一步中的说明）**** |

1. 在“**添加公共 IP 地址**”弹出窗口中，按以下设置配置后，连续单击两次“**保存**”。 完成后，单击“下一步: 后端池”。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-lbpip` |
    | SKU | Standard |
    | 层 | 区域 |
    | 分配 | 静态 |
    | 路由首选项 | **Microsoft 网络** |

    >**注意：** 标准 SKU 提供静态 IP 地址。 静态 IP 地址在创建资源时分配，并在删除资源时释放。  

1. 在“后端池”选项卡上，单击“添加后端池”并进行如下设置（其他设置保留默认值）。 单击“**添加**”，然后单击“**保存”**。 单击“**下一页：入站规则**”。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-be` |
    | 虚拟网络 | **az104-06-vnet1** |
    | 后端池配置 | **NIC** |
    | 单击“添加”以添加虚拟机 |  |
    | az104-06-vm0 | 选中框 |
    | az104-06-vm1 | 选中框 |

1. 当你有时间时，请查看其他选项卡，然后单击“查看 + 创建”。**** 确保没有验证错误，然后单击“创建”。

1. 等待负载均衡器部署，然后单击“转到资源”。

**添加规则以确定传入流量的分布方式**

1. 在“设置”**** 边栏选项卡中，选择“负载均衡规则”****。

1. 选择“+ 添加”。 添加负载均衡规则并进行以下设置（其他设置保留默认值）。  配置规则时，使用信息图标了解每个设置。 完成后，单击“保存”****。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-lbrule` |
    | IP 版本 | **IPv4** |
    | 前端 IP 地址 | **az104-fe** |
    | 后端池 | **az104-be** |
    | 协议 | **TCP** |
    | 端口 | `80` |
    | 后端端口 | `80` |
    | 运行状况探测 | **新建** |
    | 名称 | `az104-hp` |
    | 协议 | **TCP** |
    | 端口 | `80` |
    | 间隔 | `5` |
    | 关闭“创建运行状况探测”窗口 | **保存** |
    | 会话暂留 | **无** |
    | 空闲超时(分钟) | `4` |
    | TCP 重置 | **已禁用** |
    | 浮动 IP | **已禁用** |
    | 出站源网络地址转换 (SNAT) | 推荐 |

1. 从负载均衡器页中选择“前端 IP 配置”。**** 复制公共 IP 地址，

1. 打开另一个浏览器标签页并导航到该 IP 地址。 验证浏览器窗口是否显示消息“Hello World from az104-06-vm0”或者“Hello World from az104-06-vm1”。

1. 刷新窗口以验证对其他虚拟机的消息更改。 这演示了通过虚拟机轮换的负载均衡器。

    > 注意：可能需要多次刷新或在 InPrivate 模式下打开新的浏览器窗口。

## 任务 3：配置 Azure 应用程序网关

在此任务中，在两台 Azure 虚拟机前实现 Azure 应用程序网关。 应用程序网关为后端池中定义的资源提供第 7 层负载均衡、Web 应用程序防火墙 (WAF)、SSL 终止和端到端加密。 应用程序网关将图像路由到一台虚拟机，将视频路由到另一台虚拟机。

## 体系结构图 - 应用程序网关

>**注意**：此应用程序网关与负载均衡器在同一虚拟网络中工作。 这在生产环境中可能并不常见。

![实验室任务示意图。](../media/az104-lab06-gw-architecture.png)

1. 在 Azure 门户中，搜索并选择 `Virtual networks`。

1. 在“**虚拟网络**”边栏选项卡上的虚拟网络列表中，单击“**az104-06-vnet1**”。

1. 在“**az104-06-vnet1**”虚拟网络边栏选项卡的“**设置**”部分，单击“**子网**”，然后单击“**+ 子网**”。

1. 添加一个子网，其设置如下（其他设置保留默认值）。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `subnet-appgw` |
    | 开始地址| `10.60.3.224` |
    | 大小 | `/27` - 确保**起始地址**仍为 **10.60.3.224**|

1. 单击“添加”****

    > **注意**：此子网由 Azure 应用程序网关使用。 应用程序网关需要一个 /27 或更大的专用子网。

1. 在 Azure 门户中，搜索并选择 `Application gateways`，并在“应用程序网关”边栏选项卡中单击“+ 创建”********。

1. 在“基本信息”选项卡上，指定以下设置（其他设置保留默认值）：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | 你的 Azure 订阅 |
    | 资源组 | `az104-rg6` |
    | 应用程序网关名称 | `az104-appgw` |
    | 区域 | 任务 1 中使用的同一 Azure 区域**** |
    | 层 | 标准 V2 |
    | 启用自动缩放 | **否** |
    | 实例计数 | `2` |
    | HTTP2 | **已禁用** |
    | 虚拟网络 | **az104-06-vnet1** |
    | 子网 | subnet-appgw (10.60.3.224/27) |

1. 单击“下一步: 前端 >”并指定以下设置（其他设置保留默认值）。 完成后，请单击“确定”****。

    | 设置 | 值 |
    | --- | --- |
    | 前端 IP 地址类型 | **Public** |
    | 公共 IP 地址| **添加新内容** |
    | 名称 | `az104-gwpip` |
    | 可用性区域 | **1** |

    >**注意：** 应用程序网关可以同时具有公共 IP 地址和专用 IP 地址。
 
1. 单击“下一步: **** 后端 >”，然后单击“添加后端池”。**** 指定以下设置（其他设置保留默认值）。 完成后，单击“添加”。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-appgwbe` |
    | 添加没有目标的后端池 | **否** |
    | 虚拟机 | **az104-06-nic1 (10.60.1.4)** |
    | 虚拟机 | **az104-06-nic2 (10.60.2.4)** |

1. 单击“添加后端池”****。 这是图像的后端池****。 指定以下设置（其他设置保留默认值）。 完成后，单击“添加”。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-imagebe` |
    | 添加没有目标的后端池 | **否** |
    | 虚拟机 | **az104-06-nic1 (10.60.1.4)** |

1. 单击“添加后端池”****。 这是视频的后端池****。 指定以下设置（其他设置保留默认值）。 完成后，单击“添加”。

    | 设置 | 值 |
    | --- | --- |
    | 名称 | `az104-videobe` |
    | 添加没有目标的后端池 | **否** |
    | 虚拟机 | **az104-06-nic2 (10.60.2.4)** |

1. 选择“下一页:**** 配置 >”，然后选择“添加路由规则”。**** 填写信息。

    | 设置 | 值 |
    | --- | --- |
    | 规则名称 | `az104-gwrule` |
    | 优先级 | `10` |
    | 侦听器名称 | `az104-listener` |
    | 前端 IP | **** 公共 IPv4 |
    | 协议 | **HTTP** |
    | 端口 | `80` |
    | 侦听器类型 | **基本** |

1. 移动到“后端目标”选项卡****。填写基本信息后，选择“添加”****。

   | 设置 | “值” |
    | --- | --- |
    | 后端目标 | `az104-appgwbe` |
    | 后端设置 | `az104-http`（新建） |

   >**注意：** 请花一分钟时间阅读有关“基于 Cookie 的相关性”和“连接排出”的信息********。

1. 在“基于路径的路由”部分中，选择“添加多个目标以创建基于路径的规则”********。 将创建两个规则。 单击第一个规则后的“**添加**”，然后单击第二个规则后的“**添加**”。 

    **规则 - 路由到图像后端**

    | 设置 | “值” |
    | --- | --- |
    | 路径 | `/image/*` |
    | 目标名称 | `images` |
    | 后端设置 | **az104-http** |
    | 后端目标 | `az104-imagebe` |

    **规则 - 路由到视频后端**

    | 设置 | “值” |
    | --- | --- |
    | 路径 | `/video/*` |
    | 目标名称 | `videos` |
    | 后端设置 | **az104-http** |
    | 后端目标 | `az104-videobe` |

1. 请务必检查更改，然后选择“**下一页：标记 >**”。 无需任何更改。

1. 选择“下一页:**** 查看 + 创建 >”，然后单击“创建”****。

    > **注意**：等待应用程序网关实例创建完毕。 这大约需要 5-10 分钟。 等待时，可以查看本页末尾的一些自定进度培训链接。

1. 部署应用程序网关后，搜索并选择“az104-appgw”****。

1. 在“应用程序网关”资源中的“监视”部分中，选择“后端运行状况”************。

1. 确保后端池中的两个服务器都显示“正常”****。

1. 在“概述”边栏选项卡上，复制“前端公共 IP 地址”的值********。

1. 启动另一个浏览器窗口并测试此 URL - `http://<frontend ip address>/image/`。

1. 验证是否已定向到图像服务器（vm1）。

1. 启动另一个浏览器窗口并测试此 URL - `http://<frontend ip address>/video/`。

1. 验证是否已定向到视频服务器（vm2）。

> 注意：可能需要多次刷新或在 InPrivate 模式下打开新的浏览器窗口。

## 清理资源

如果使用自己的订阅，需要一点时间删除实验室资源****。 这将确保资源得到释放，并将成本降至最低。 删除实验室资源的最简单方法是删除实验室资源组。 

+ 在 Azure 门户中，选择资源组，选择“删除资源组”，输入资源组名称，然后单击“删除”************。
+ `Remove-AzResourceGroup -Name resourceGroupName`（使用 Azure PowerShell）。
+ `az group delete --name resourceGroupName`（使用 CLI）。

## 使用 Copilot 扩展学习

Copilot 可帮助你了解如何使用 Azure 脚本工具。 Copilot 还可以帮助了解实验室中未涵盖的领域或需要更多信息的领域。 打开 Edge 浏览器并选择“Copilot”（右上角）或导航到*copilot.microsoft.com*。 花几分钟时间尝试这些提示。

+ 将 Azure 负载均衡器与 Azure 应用程序网关进行比较和对比。 帮助我确定我应该在哪些场景中使用每款产品。
+ 可使用哪些工具对与 Azure 负载均衡器的连接问题进行故障排除？ 
+ 配置 Azure 应用程序网关的基本步骤是什么？ 提供高级清单。 
+ 创建突出显示三个 Azure 负载均衡解决方案的表。 对于每个解决方案，显示支持的协议、路由策略、会话相关性和 TLS 卸载。
  
## 通过自定进度的培训了解详细信息

+ [使用 Azure 负载均衡器提高应用程序的可伸缩性和复原能力](https://learn.microsoft.com/training/modules/improve-app-scalability-resiliency-with-load-balancer/)。 介绍 Azure 中的不同负载均衡器，以及如何选择正确的 Azure 负载均衡器解决方案以满足需求。
+ [使用应用程序网关对 Web 服务流量进行负载均衡](https://learn.microsoft.com/training/modules/load-balance-web-traffic-with-application-gateway/)。 通过将负载分散到多个服务器并使用基于路径的路由定向 Web 流量提高应用程序复原能力。

## 关键结论

恭喜你完成本实验室的内容。 以下是本实验室的要点。

+ Azure 负载均衡器是在传输层（OSI 第 4 层 - TCP 和 UDP）跨多个虚拟机分配网络流量的绝佳选择。
+ 公共负载均衡器用于对传入 VM 的 Internet 流量进行负载均衡。 内部（或专用）负载平衡器 用于仅在前端需要专用 IP 的情况。
+ 基本负载均衡器适用于不需要高可用性或冗余的小型应用程序。 标准负载均衡器可实现高性能和超低延迟。
+ Azure 应用程序网关是一种 Web 流量（OSI 第 7 层）负载均衡器，可用于管理 Web 应用程序的流量。
+ 应用程序网关标准层提供所有 L7 功能（包括负载均衡），WAF 层添加防火墙来检查恶意流量。
+ 应用程序网关可以根据 HTTP 请求的其他属性（例如 URI 路径或主机头）进行路由决策。
